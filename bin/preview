#!/usr/bin/env ruby

# Credit to https://github.com/github/cmark-gfm
# Get the first 20 lines from the GitHub markdown cheatsheet HTML file
html_head = File.readlines('docs/github_markdown_cheatsheet.html')[0,20].join

# Find the latest exported markdown file
latest_md = Dir.glob('claude-conversations/*.md').sort.last

if latest_md.nil?
  puts "No markdown files found in claude-conversations/"
  exit 1
end

puts "Creating preview for: #{File.basename(latest_md)}"

# Use cmark-gfm to convert markdown to HTML with --unsafe for collapsed sections
md_html = `cmark-gfm --unsafe --extension table --extension strikethrough --extension autolink --extension tagfilter --extension tasklist "#{latest_md}"`

if $?.exitstatus != 0
  puts "Error running cmark-gfm. Make sure it's installed:"
  puts "  brew install cmark-gfm"
  exit 1
end

# Create the complete HTML content
full_html = html_head + "\n<div class=\"preview theme-light\">" + md_html + "\n</div></body></html>"

# Create HTML file in claude-conversations folder
html_filename = latest_md.gsub(/\.md$/, '.html')
File.write(html_filename, full_html)

puts "Preview saved to: #{html_filename}"

# Open in the default browser unless --no-open flag is passed
unless ARGV.include?('--no-open')
  system("open", html_filename)
  puts "Opening in browser..."
else
  puts "Skipping browser open due to --no-open flag"
end